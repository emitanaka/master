---
title: "Visual Inference for Graphcial Diagnostic of Linear Mixed Models"
#subtitle: "âš”<br/>with xaringan"
author: "Kaiwen Jin"
institute: "Monash University"
date: "2020-09-18"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

# Linear Mixed Model

- What is a linear mixed model?

   $$\boldsymbol{y = X\beta + Zb + e}$$
where 
  - $\mathbf{y}$ is a $\mathbf{N \times 1}$ vector of observations, outcome variable
  - $\mathbf{X}$ is a $\mathbf{N \times p}$ matrix
  - $\boldsymbol\beta$ is a $\mathbf{p \times 1}$ vector of the fixed effect
  - $\mathbf{b}$ is a $\mathbf{N \times q}$ matrix
  - $\mathbf{b}$ is a $\mathbf{q \times 1}$ vector of the random effect
  - $E[\mathbf{y}] = \boldsymbol{X\beta}$ and $V(\mathbf{y}) = \mathbf\Omega = \boldsymbol{Z\Gamma Z^\top + R}$

- Where and why should we use the linear mixed model?
  - flexible
    
- How can we implement the linear mixed model?
  - `lmer` function from `lme4` package
  - `mmer` function from `sommer` package
  
---

# Visual inference for graphcial diagnostic

- What are the classical statistical inference?
  + t-test, F-test or likelihood ratio - fixed effect
  + AIC, BIC - nested model
  + likelihood ratio test - random effect

- Why we want to use the graphical diagnostic?

  Graphical diagnostic is useful to see when there is a problem with the model and where it occurs, besides, it gives some signs that what could be the reason of the issue.

- How does it works?
  - lineups

---

# Graphical diagnostic on residual analysis

* Types of residuals and corresponding residual diagnostic purpose:

  - Marginal residuals, $\boldsymbol{\hat\xi = y - X\hat \beta}$
      + Linear of the effects fixed 
      + Presence of outlying observations
      + Within-units covariance matrix 
    
  - Conditional residuals, $\boldsymbol{\hat e = y - X\hat \beta - Z\hat b}$
      + Presence of outlying observations 
      + Homoskedasticity of conditional errors 
      + Normality of conditional errors 
      
  - Random effect residuals, $\mathbf{Z\hat b}$
      + Presence of outlying subjects 
      + Normality of the random effects 

---

# Linguistic data

```{r setup, include = FALSE}
library(lme4)
library(tidyverse)
library(ggbeeswarm)
library(colorspace)
library(ggplot2)
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE#,
  #cache.path = "cache/",
  #cache = TRUE
)
df <- read_csv('~/Desktop/Masters/Master_Econometrics/S2 2020/ETF5550/master/data/politeness_data.csv') %>% 
  mutate(scenario = fct_reorder(factor(scenario), frequency, function(x) mean(x, na.rm = TRUE)),
         subject = fct_reorder(subject, frequency, function(x) mean(x, na.rm = TRUE)))

fit <- lmer(frequency ~ attitude + gender + 
              (1|subject) + (1|scenario),
            data = df)

N <- nrow(df)
subjects <- unique(df$subject)
nsubject <- length(subjects)
scenarios <- unique(df$scenario)
nscenario <- length(scenarios)
y <- df$frequency
X <- model.matrix(~attitude + gender, data = df)
beta <- fixef(fit)
Z1 <- model.matrix(~subject - 1, data = df)
Z2 <- model.matrix(~scenario - 1, data = df)
Z <- cbind(Z1, Z2)
u <- c(ranef(fit)$subject[,1], ranef(fit)$scenario[,1])
q <- length(u)
vc <- as.data.frame(VarCorr(fit))
R <- vc$vcov[vc$grp=="Residual"] * diag(N)
G1 <- vc$vcov[vc$grp=="subject"] * diag(nsubject)
G2 <- vc$vcov[vc$grp=="scenario"] * diag(nscenario)
G <- Matrix::bdiag(G1, G2)
Sigma <- Z %*% G %*% t(Z)  + R
Sigma_inv <- solve(Sigma)
varMargRes <- Sigma - X %*% solve(t(X) %*% solve(Sigma) %*% X) %*% t(X)
P <- Sigma_inv - Sigma_inv %*% X %*% solve(t(X) %*% Sigma_inv %*% X) %*% t(X) %*% Sigma_inv
varCondRes <- R %*% P %*% R
varU <- G - G %*% t(Z) %*% P %*% Z %*% G


fit_df <- df %>% 
  mutate(fitted = as.vector(X %*% beta),
         resm = frequency - fitted, 
         resc = frequency - fitted - as.vector(Z %*% u),
         index = 1:n()) %>% 
  rowwise() %>% 
  mutate(resm_std = resm / sqrt(diag(varMargRes)[index]),
         resc_std = resc / sqrt(diag(varCondRes)[index])) %>% 
  ungroup()

unit_df <- expand_grid(subjects, scenarios) %>% 
  # cannot follow Vi quit well
  mutate(Vi = map2_dbl(subjects, scenarios, ~{
                        ind <- df %>% 
                          mutate(index = 1:n()) %>% 
                          filter(subject==.x,
                                 scenario==.y) %>% 
                          pull(index)
                        mi <- length(ind)
                        # standardised marginal residual
                        Ei <- solve(varMargRes[ind, ind]) %*% fit_df$resm[ind]
                        sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
                      }),
         Mi = as.vector(t(u) %*% solve(varU) %*% u)
         )
ggplot(fit_df, aes(index, resc_std, 
                   color = subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) + 
  scale_color_discrete_qualitative()
```

```{r fig.height=4, dev='svg'}
fit_df %>% 
  arrange(scenario) %>% 
  mutate(index = 1:n()) %>% 
  ggplot(aes(index, resc_std, color = scenario)) + 
  geom_point() + 
  geom_hline(yintercept = 0) + 
  scale_color_discrete_qualitative()
```

---
# Motivation: Justify the research topic

* define topic

  * What is linear mixed model?



  * Why use the visual inference rather than the classical statistical inference?
    - what are the classical statistical inference?
      + t-test, F-test or likelihood ratio - fixed effect
      + AIC, BIC - nested model
      + likelihood ratio test - random effect
    - parallel

* why would we use the plots to do the diagnostic rather than the classical inference

Although we always using ggplot to do the graph, we never think about the plots can replace the statistical inference.

LME is the new contents for me.

Love coding

* benefits

- what is relevent to topic
- what is not relevent

---

# Objectives - research questions

"Which plot is most different"
---

# Literature review

- your topic is significant
- you understant the topic
- main point: distinguish your research from similar current research

describe significant contributions
analyse the strengths and weaknesses of these contributions
describe how these are relevant to your research
identify how you will extend on the current research; that is your contribution

---

# Purpose of the project plan?

* state the data and the data sources you will use
* outline how you will collect and manage 
* introduce the methodology

---