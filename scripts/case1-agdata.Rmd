---
title: "Case: Agricultural Data"
date: "`Sys.Date()`"
output:
  html_document
---

```{r setup, warning = FALSE, message = FALSE}
library(agridat) # various ag data sets
library(sommer) # for fitting mixed models
library(tidyverse)
library(ggplot2)
library(lme4)
library(expm)
data(bridges.cucumber)
df <- bridges.cucumber %>% 
  mutate(rowf = factor(row),
         colf = factor(col))
A <- diag(nlevels(df$gen))
rownames(A) <- colnames(A) <- levels(df$gen)
```

```{r data-summary}
skimr::skim(df)
```


```{r}
fit <- mmer(yield ~ 1 + loc,
            # random: random effects
            # vs(ds(x), y): diagonal covariance structure for the "y" covariate for all 
            # levels of the factor covariate "x"
            random =~ vs(ds(loc), gen, Gu = A),
            # rcov: error term
            rcov =~ units,
            data = df)

randef(fit)

# data frame of fixed effects (BLUEs)
fit$Beta

# list for each random effect (BLUPs)
fit$U

# residual values (Marginal residuals)
fit$residuals

plot(fit)
```

```{r values}
y <- df$yield
X <- model.matrix(~loc, data = df)
beta_hat <- fit$Beta$Estimate
# get reid of the intercept
Z <- model.matrix(~gen:loc -1, data = df)
b_hat <- unlist(fit$U)

Sigma <- solve(fit$Vi)
# simulate y
MASS::mvrnorm(n = 1, mu = X %*% beta_hat, Sigma = Sigma)

Sigmai <- fit$Vi
Sigmai_sqrt <- expm::sqrtm(fit$Vi)

# residuals
resm <- y - X %*% beta_hat; resm <- resm[,1]
all(resm == fit$residuals) # TRUE
resc <- y - X %*% beta_hat - Z %*% b_hat; resc <- resc[,1]
resre <- Z %*% b_hat; resre <- resre[,1]

vareps <- Sigmai_sqrt %*% resm; vareps <- vareps[,1]
tvar <- Sigma - X %*% solve(t(X) %*% Sigmai %*% X) %*% t(X)
smres <- resm/sqrt(diag(tvar))

df2 <- tibble(y, resm, resc, resre, smres, fitted = fit$fitted[,1])
```

```{r plot 1}
ggplot(data = df2, mapping = aes(x = fitted, y = smres)) +
  geom_point() + geom_hline(color = "red", yintercept = 0)
```

```{r plot2}
ggplot(data = df2, mapping = aes(x = 1:nrow(df), y = smres)) +
  geom_point() + geom_hline(color = "red", yintercept = 0)
```

```{r adequacy measure of the within-unit covariance structure}
I32 <- diag(32)
Vi <- Matrix::norm(x = I32 - vareps %*% t(vareps), type = "2")
stdVi <- sqrt(Vi)/32
```

???? quit confused with how to figure out the within-unit covariance structure Vi, from above it is just a scalar.
```{r plot 3}

```

```{r}
Q <- Sigmai - Sigmai %*% X %*% solve(t(X) %*% Sigmai %*% X) %*% t(X) %*% Sigmai
#G <- matrix(unlist(fit$VarU), 8,8) # this may not be correct

mat1 <- matrix(c(as.vector(fit$VarU[[1]]$yield), rep(0, 16)), 4, 8)
mat2 <- matrix(c(rep(0, 16), as.vector(fit$VarU[[2]]$yield)), 4, 8)
G <- rbind(mat1, mat2)

R <- Sigma - Z %*% G %*% t(Z)

vare_hat <- R %*% Q %*% R

resc <- y - X %*% beta_hat - Z %*% b_hat; resc <- resc[,1]
scres <- resc/sqrt(diag(vare_hat))

df3 <- tibble(y, resc, scres, fitted = fit$fitted[,1])
```

Presence of outlying observations ($\mathbf{y}_{ij}$)
```{r plot 4}
ggplot(df3, aes(1:nrow(df), scres)) + geom_point() +
  geom_hline(yintercept = 0, color = "red")
```

There may be an outlying observation at the left right coner..

Homoskedasticity of conditional errors ($\mathbf{e}_{ij}$)
```{r plot 5}
ggplot(df3, aes(fitted, scres)) + geom_point() +
  geom_hline(color = "red", yintercept = 0)
```


Normality of conditional errors
```{r plot 6}

```
how to get the $\mathbf{L}$ and $\Lambda$??
Is the $\mathbf{L}$ comes from unit-specific linear combinations of the form
$$\mathbf{L}_i = \mathbf{K}_1^\top \boldsymbol{\beta} + \mathbf{K}_2^\top \mathbf{b}_i$$

How to know $\mathbf{K}_1$ and $\mathbf{K}_$..

```{r}
pev <- fit$PevU
mat1 <- matrix(c(as.vector(fit$VarU[[1]]$yield), rep(0, 16)), 4, 8)
mat2 <- matrix(c(rep(0, 16), as.vector(fit$VarU[[2]]$yield)), 4, 8)
matrix(c(as.vector(fit$PevU[[1]]$yield)),4,4)
matrix(c(as.vector(fit$PevU[[2]]$yield)),4,4)

M <- matrix(c((fit$PevU[[1]]$yield)))
```

Presence of outlying subjects
```{r plot 7}

```

Normality of the random effects
```{r plot 8}

```

