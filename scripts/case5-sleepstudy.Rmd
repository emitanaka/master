---
title: "case5"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
library(mvtnorm)
library(dplyr)
library(tidyverse)
library(plyr)
library(nullabor)
```

```{r}
data("sleepstudy")
head(sleepstudy)
skimr::skim(sleepstudy)
summary(sleepstudy)
```

```{r}
ggplot(sleepstudy, aes(Days, Reaction)) + geom_point() + facet_wrap(~Subject) + geom_smooth(method = "lm", se = FALSE)

ggplot(sleepstudy, aes(Subject, Reaction)) + geom_boxplot()
```

```{r}
testrandom <- plyr::ddply(sleepstudy, .(Subject), function(x) {
  m <- lm(Reaction ~ Days, data = x)
  data.frame(x, fitted = fitted(m))	
})

ggplot(testrandom, aes(Days, fitted, group = Subject)) + geom_line()
```

Therefore, from the plots, the model needs the random intercept and random slope.

```{r}
# random intercept and random slope
slmod1 <- lmer(Reaction ~ Days + (Days|Subject), data = sleepstudy)
# independent random effects
slmod2 <- lmer(Reaction ~ Days + (Days -1 |Subject) + (1|Subject), data = sleepstudy)
#summary(slmod1)
#summary(slmod2)

set.seed(987654321)
sl.mod2.sims  <- simulate(slmod2, nsim = 19)
sl.mod2.refit <- lapply(sl.mod2.sims, refit, object = slmod2)
sl.mod2.sim.ranef <- lapply(sl.mod2.refit, function(x) ranef(x)[[1]])
sl.mod2.sim.ranef <- do.call("rbind", sl.mod2.sim.ranef)
sl.mod2.sim.ranef$.n <- rownames(sl.mod2.sim.ranef)
sl.mod2.sim.ranef$.n <- as.numeric(str_extract(sl.mod2.sim.ranef$.n, "\\d+"))
true.sl.mod1.ranef <- ranef(slmod1)$Subject
sl_df <- nullabor:::add_true(sl.mod2.sim.ranef, true.sl.mod1.ranef, pos = 9)
ggplot(data = sl_df, aes(x = `(Intercept)`, y = Days)) + 
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, alpha = 0.4) +
  facet_wrap( ~ .sample, ncol=5) + 
  xlab(NULL) + 
  ylab(NULL)
```

Since the true plot is indistinguishable from the null plots, there is no need for the correlation between the random effects.

Hence the model is shown in `slmod2`.

From the true model, replicating the data for 4 times by $y \sim (X\beta, \Omega)$, where $\Omega = Z\Gamma Z^\top + R$ and refitting the model with $y = X\beta + Zb + e$ and get the plots & null plots.

- Version 1: 'best' model
- Version 2: slight noise (error is correlated such as `kronecker(diag(3), matrix(1, nrow = 2, ncol = 2))`, sample from the data by adding small values to the sample data)
- Version 3: Extreme value (with obvious outlier but not that obvious)

Since $M_i$ are the same for each case, the plot 7 and 8 are ignored!

$$\boldsymbol y \sim N(X\beta, Z \Gamma Z^\top + R)$$

```{r fitfn}
extract.fitted.mod.v1 <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X")
  beta <- fixef(mod)
  Z <- getME(mod, "Z")
  u <- c(ranef(mod)$Subject[,1], ranef(mod)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G

  fitted_df <- data %>% 
    dplyr::mutate(
      fitted = as.vector(X %*% beta),
      resm = y - fitted,
      resc = as.vector(y - fitted - Z %*% u),
      index = 1:n()) %>% 
    mutate(resm_std = resm/sqrt(diag(varMargRes)[index]),
           resc_std = resc/sqrt(diag(varCondRes)[index])) %>% 
    ungroup()
  
  return(fitted_df)
}
```

```{r unitfn}
extract.unit.mod.v1 <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X")
  beta <- fixef(mod)
  Z <- getME(mod, "Z")
  u <- c(ranef(mod)$Subject[,1], ranef(mod)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted <-  as.vector(X %*% beta)
  resm <-  y - fitted
  resc <-  as.vector(y - fitted - Z %*% u)

  unit_df <- expand_grid(subjects) %>% 
  dplyr::mutate(Vi = map_dbl(subjects, ~{
    ind <- data %>% 
      dplyr::mutate(index = 1:n()) %>% 
      filter(Subject == .x) %>% 
      pull(index)
    mi <- length(ind)
    Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
    #norm((diag(mi)- Ei %*% t(Ei)))
    v1 <- (diag(mi)- Ei %*% t(Ei))
    sqrt(sum(diag(v1 %*% t(v1)))) / mi
    #sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
  }),
  Mi = as.vector(t(u) %*% solve(varU) %*% u),
  index = 1:n())
  
  return(unit_df)
}
```

```{r lcrfn}
extract.lcr.mod.v1 <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X")
  beta <- fixef(mod)
  Z <- getME(mod, "Z")
  u <- c(ranef(mod)$Subject[,1], ranef(mod)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted <-  as.vector(X %*% beta)
  resm <-  y - fitted
  resc <-  as.vector(y - fitted - Z %*% u)
  index <- 1:nrow(data)
  resm_std <-  resm/sqrt(diag(varMargRes)[index])
  resc_std = resc/sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))

  resmcp_sl <- tibble::tibble(resmcp)
  
  return(resmcp_sl)
}
```

```{r simulate}
sim <- function(mod, data, nsim = 19, seed, std = FALSE){
  fit.sim <- simulate(mod, nsim = nsim, seed = seed)
  fit.refit <- lapply(fit.sim, refit, object = mod)
  fit.simy <- lapply(fit.refit, function(x) getME(x, 'y'))
  fit.simy.y <- do.call("cbind", fit.simy)
  fit.simy.y <- reshape2::melt(fit.simy.y)[-1]
  names(fit.simy.y) <- c(".n", "y")
  fit.simy.y$.n <- as.numeric(str_extract(fit.simy.y$.n, "\\d+"))
  fit.simy.y$Subject <- rep(data$Subject, 19)
  fit.simy.y$Days <- rep(data$Days, 19)
  return(fit.simy.y)
}
```

## Version 1

### Data plots from the 'best' model

```{r v1-plotdf}
repc <- sleepstudy
colnames(repc)[1] <- c("y")
v1.fitted <- extract.fitted.mod.v1(slmod2, repc)
v1.unit <- extract.unit.mod.v1(slmod2, repc)
v1.lcr <- extract.lcr.mod.v1(slmod2, repc)
```

```{r v1-plot}
ggplot(v1.fitted, aes(fitted, resm_std)) + geom_point() + geom_smooth(method = "loess")

ggplot(v1.fitted, aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +theme(legend.position = "none")

# Dashed line: third quartile + 1.5 interquartile range
LSlesverb <- as.numeric(quantile(v1.unit$Vi,prob = 0.75) + 1.5*(quantile(v1.unit$Vi, prob = 0.75) - quantile(v1.unit$Vi,prob = 0.25)))
ggplot(v1.unit, aes(index, Vi)) + geom_point() + geom_hline(yintercept = LSlesverb, lty = 2) +
  geom_text(
    data = v1.unit %>% 
      filter(Vi>LSlesverb),
    aes(label = index),
    nudge_x = 0.35, nudge_y = 0.35,
    size = 2
  )

ggplot(v1.fitted, aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) + theme(legend.position = "none") +
  geom_text(
    data = v1.fitted %>% 
      filter(abs(resc_std)>4),
    aes(label = index),
    nudge_x = 0.35, nudge_y = 0.35,
    check_overlap = T,
    size = 2
  )

ggplot(v1.fitted, aes(fitted, resc_std)) + geom_point() + 
  geom_text(
    data = v1.fitted %>% 
      filter(abs(resc_std)>4),
    aes(label = index),
    nudge_x = 0.35, nudge_y = 0.35,
    check_overlap = T,
    size = 2
  )

ggplot(v1.fitted, aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = 'red')

ggplot(v1.lcr, aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red")
```

- There is no obvious trend in plot 1. It seems to be linearity of effects fexed ($\boldsymbol{\mathbb{E}[y] = X\beta}$).
- There is no evidence showing the presence of outlying observations.
- The indexs (1 and 6) indicates that those units' covariance structure should be modified in Plot 3.
- Plot 4 show that the the index for 8, 57 and 60 are the outlying observations in the reaction values. 
  + Index 8 shows a significant drop at day 7 for subject 308
  + Index 57 shows an increase at day 6 for subject 332
  + Index 60 shows a drop at day 9 for subject 332
- Although there are some outliers in the plot 5, there is no evidence show heteroscedasticity of conditional residuals.
- Plot 6 shows the Gaussian QQ plot for the conditional residuals. However, from the plot, there are obvious tails. One extreme point on the upper end and two on the lower end may seem exceptional. The conditonal residuals might not follow a normal distribution.
- Plot 7 shows the Gaussian QQ plot for the least confounded residuals. There also shows some tails.
  

### 1st replication

#### Simulation

```{r}
v11.sim <- sim(slmod2, repc, seed = 1234)
```


```{r nullfitted-v11}
v11.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v11.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v11}
v11_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v11.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))

  tibble::tibble(df[1:178,], resmcp)
})
```

```{r nullunit-v11}
v11.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v11.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

##### Lineup plots

```{r v11n-plot1, fig.height=6}
lineup(true = v1.fitted, samples = v11.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + 
  geom_point() + 
  geom_smooth(method = "loess") +
  facet_wrap( ~ .sample, ncol=5)
```


```{r v11n-plot2, fig.height = 6}
lineup(true = v1.fitted, samples = v11.sim.fitted, pos = 7) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The true plot might be hard to be distinguished.


```{r v11n-plot3, fig.height=6}
lineup(true = v1.unit, samples = v11.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

- The true plot can be identified. Therefore the covariance matrix ($\Omega_i$) need to be modified.

```{r v11n-plot4, fig.height=6}
lineup(true = v1.fitted, samples = v11.sim.fitted, pos = 7) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- By comparing with the marginal residual, the conditional residual seems to be better on detecting the plots.
- The true plot might be identified since there are three outliers, two at the bottom and one at the top.

```{r v11n-plot5, fig.height=6}
lineup(true = v1.fitted, samples = v11.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5)
```

```{r v11n-plot6, fig.height=6}
lineup(true = v1.fitted, samples = v11.sim.fitted, pos = 9) %>% 
  ggplot(aes(sample = resc_std)) + 
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol=5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The true plot should be identified. One extreme point on the upper end and two on the lower end may seem exceptional compared with the overall trend of conditional residual distribution. Hence, the conditional residual does not follow a normal distribution.

```{r v11n-plot6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v11_simlcr, pos = 9) %>% 
  ggplot(aes(sample = resmcp)) + 
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol=5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- By comparing with the conditional residual, the true plot for the least confounded residual may not able to be distinguished. Althogh it may not a normal distribution.


### 2nd replication

### Simulation

```{r}
v12.sim <- sim(slmod2, repc, seed = 2345)
```

```{r nullfitted-v12}
v12.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v12.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v12}
v12_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v12.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v12}
v12.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v12.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

#### Lineup plots

```{r v12n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v12.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

```{r v12n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v12.sim.fitted, pos = 7) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- I would expect that the viewers can see the value for the orange part are squeezed together at the bottom. And an outlier on the top for the green subject.

```{r v12n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v12.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

- Two points at the top seem like outliers then the true plot can be identified. It shows that the covariance matrix of these two units need to modified.

```{r v12n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v12.sim.fitted, pos = 7) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  geom_hline(yintercept = 4, lty = 3) +
  geom_hline(yintercept = -4, lty = 3) +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- Two points on the bottom and one point at the top are exceptional. Then the true plot can be identified.
- The true plot from conditional residual is easy to identified compared with the null plots of marginal residuals.

```{r v12n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v12.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

- Aim is to see if there is a pattern in the plot which conditional residual v.s fitted value. If shown, then it shows the heteroscedasticity of conditional residuals.

```{r v12n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v12.sim.fitted, pos = 9) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- Two points on the lower end and one plot on the upper end seem exceptional compared to overall conditional residual distribution. Hence, for the true plot, the distribution is not normal.

```{r v12n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v12_simlcr, pos = 9) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

For the least confounded residual, it is hard to distinguish the true plot among the null plots.

### 3rd replication

### Simulation

```{r}
v13.sim <- sim(slmod2, repc, seed = 3456)
```

```{r nullfitted-v13}
v13.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v13.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v13}
v13_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v13.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v13}
v13.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v13.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

#### Lineup plots

```{r v13n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v13.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + 
  geom_point(alpha = 0.8) + 
  geom_hline(yintercept = 0) +
  geom_smooth(method='loess') +
  facet_wrap(~.sample, nrow = 5)
```

```{r v13n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v13.sim.fitted, pos = 13) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v13n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v13.sim.unit, pos = 8) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

For this plot, the true plot might be detected. Then the inadequate measure of covariance structure is identified.

```{r v13n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v13.sim.fitted, pos = 13) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

The conditional residual plot is more easy compared with marginal residual to detect the true plot.

True plot is identified, there is evidence showing the outlying observation.

```{r v13n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v13.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

- There are some patterns showing in the null plots.

```{r v13n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v13.sim.fitted, pos = 4) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- Identified!

```{r v13n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v13_simlcr, pos = 4) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

Same here, the conditional residual QQ-plot is easy to identify. However, the least confounded residual is hard to be distinguished.

### 4th replication

### Simulation

```{r}
v14.sim <- sim(slmod2, repc, seed = 9876)
```

```{r nullfitted-v14}
v14.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v14.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v14}
v14_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v14.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v14}
v14.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v14.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

#### Lineup plots

```{r v14n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v14.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_smooth(method = 'loess') +
  facet_wrap(~.sample, nrow = 5)
```

- The true plot might hard to be identified.

```{r v14n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v14.sim.fitted, pos = 13) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The lineup maybe hard to find the true plot

```{r v14n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v14.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v14n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v14.sim.fitted, pos = 13) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The true plot is easily identified. It shows that the outlying observation of $y$.

```{r v14n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v14.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5)
```

- Some of the null plots may show some patterns.

```{r v14n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v14.sim.fitted, pos = 4) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- Identified!

The true plot is identifiable, therefore, the conditional residual does not follow a Normal distribution.

```{r v14n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v14_simlcr, pos = 4) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- It is hard to distinguish..

## Version 2

Added the within unit correlation in the error term by value 1, that is for first subject, first 10 observations' error terms are correlated.

Or we sampled the day (from 0 to 9) as the index. We added 50 to the reaction value for each subject on the same day which is sampled from.

```{r}
N <- nrow(sleepstudy)
subjects <- unique(repc2$Subject)
nsubjects <- length(subjects)
X <- getME(slmod2, "X")
beta <- fixef(slmod2)
Z <- getME(slmod2, "Z")
u <- c(ranef(slmod2)$Subject[,1], ranef(slmod2)$Subject[,2])
q <- length(u)
vc <- as.data.frame(VarCorr(slmod2))
R <- vc$vcov[vc$grp == 'Residual'] * diag(N/nsubjects)
G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
G <- Matrix::bdiag(G1, G2)

R[lower.tri(R)] <- 1
R[upper.tri(R)] <- 1

R <- kronecker(diag(18), R)

Sigma <- Z %*% G %*% t(Z) + R 

set.seed(1234)
y <- as.vector(mvtnorm::rmvnorm(1, mean = X%*% beta, sigma = Sigma, checkSymmetry = FALSE))

repc2 <- tibble(y, sleepstudy$Days, sleepstudy$Subject)
colnames(repc2) <- c("y", "Days", "Subject")

# Second option:
#repc2 <- sleepstudy
#set.seed(1234)
#samp <- sample(1:10, 1)
#colnames(repc2)[1] <- "y"
#mean_subject <- ddply(repc2, .(Subject), summarise, mean = mean(y))
#mean(mean_subject$mean)*0.1
#for (i in 1:n){
#  repc2[(i*samp),]$y <- repc2[(i*samp),]$y + 30
#}

#repc2
```

```{r}
slmod3 <- lmer(y ~ Days + (Days - 1|Subject) + (1|Subject), data = repc2)

v2.fitted <- extract.fitted.mod.v1(slmod3, repc2)
v2.unit <- extract.unit.mod.v1(slmod3, repc2)
v2.lcr <- extract.lcr.mod.v1(slmod3, repc2)
```

```{r}
ggplot(v2.fitted, aes(fitted, resm_std)) + geom_point() + geom_smooth(method = 'loess')
ggplot(v2.fitted, aes(index, resm_std, color = (index %in% c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180)))) + geom_point() + theme(legend.position = "none")

# Dashed line: third quartile + 1.5 interquartile range
LSlesverb <- as.numeric(quantile(v2.unit$Vi,prob = 0.75) + 1.5*(quantile(v2.unit$Vi, prob = 0.75) - quantile(v2.unit$Vi,prob = 0.25)))
ggplot(v2.unit, aes(index, Vi)) + geom_point() + geom_hline(yintercept = LSlesverb, lty = 2) + geom_text(
  data = v2.unit %>% 
    filter(Vi>LSlesverb),
  aes(label = index),
  nudge_x = 0.05, nudge_y = 0.05,
  size = 2
)

ggplot(v2.fitted, aes(index, resc_std, color = (index %in% c(10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150, 160, 170, 180)))) + geom_point() + theme(legend.position = "none")

ggplot(v2.fitted, aes(fitted, resc_std)) + geom_point()

ggplot(v2.fitted, aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red")

ggplot(v2.lcr, aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red")
```

By adding the noise,

- plot 1 shows the nonlinearity of effects fixed
- the blue points shown in plot 2 and 4 are the noise that I've added (by adding 50 to reaction value for each subject on day 9).
- plot 6 shows the distribution is right skewed. One point on the lower end and one point on the upper end seem exceptional and thus the distribution is not normal for conditional residuals

### 1st replication

### Simulation

```{r}
v21.sim <- sim(slmod3, repc2, seed = 9876)
```

```{r nullfitted-v21}
v21.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v21.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v21}
v21_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v21.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v21}
v21.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v21.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

#### Lineup plots

```{r v21n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v21.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + 
  geom_smooth(method = "loess") +
  facet_wrap(~.sample, nrow = 5)
```

```{r v21n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v21.sim.fitted, pos = 5) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + 
  geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v21n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v21.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v21n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v21.sim.fitted, pos = 5) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + 
  geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

Both marginal residual and conditional residual are hard to detect.

```{r v21n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v21.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

Homoscedasticity in the case!

```{r v21n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v21.sim.fitted, pos = 8) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The true plot should be identified.

```{r v21n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v21_simlcr, pos = 8) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- We hope the viewers can see that one point on the lower end and one point on the upper end are not expected in the true plot. Hence, the least confounded residual does not follow a normal distribution.

### 2nd replication

### Simulation

```{r}
v22.sim <- sim(slmod3, repc2, seed = 8765)
```

```{r nullfitted-v22}
v22.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v22.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v22}
v22_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v22.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v22}
v22.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v22.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

#### Lineup plots

```{r v22n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v22.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_smooth(method = 'loess') +
  facet_wrap(~.sample, nrow = 5)
```

```{r v22n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v22.sim.fitted, pos = 5) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v22n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v22.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v22n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v22.sim.fitted, pos = 5) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The conditional residual should be more easily to be identified.

```{r v22n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v22.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5)
```


```{r v22n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v22.sim.fitted, pos = 8) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- true plot should be identified.

```{r v22n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v22_simlcr, pos = 8) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) + xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- For checking the distribution of least confounded residual, the true plot may not easy to be distinguished among the 20 plots. Then we may fail to reject the null hypothesis thatt the least confounded residual follows a Gaussian distribution.

### 3rd replication

#### Simulation

```{r}
v23.sim <- sim(slmod3, repc2, seed = 4387)
```

```{r nullfitted-v23}
v23.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v23.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v23}
v23_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v23.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v23}
v23.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v23.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

##### Lineup plots

```{r v23n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v23.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_smooth(method = "loess") +
  facet_wrap(~.sample, nrow = 5)
```

```{r v23n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v23.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v23n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v23.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v23n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v23.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5) + theme(legend.position = "none")
```

- We wish the viewers to the outlying observations in the true plot since the three points are the outliers compared with others.

```{r v23n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v23.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5)
```

```{r v23n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v23.sim.fitted, pos = 20) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) + xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The true plot should be identified.

```{r v23n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v23_simlcr, pos = 20) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- From these two plots, the conditional residual is easy to identified but the least confounded residual is hard to distinguish.

### 4th replication

#### Simulation

```{r}
v24.sim <- sim(slmod3, repc2, seed = 8696)
```

```{r nullfitted-v24}
v24.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v24.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v24}
v24_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v24.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v24}
v24.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v24.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

##### Lineup plots

```{r v24n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v24.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_smooth(method = "loess") +
  facet_wrap(~.sample, nrow = 5)
```

```{r v24n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v24.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v24n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v24.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v24n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v24.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

The true plot is identified.

```{r v24n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v24.sim.fitted, pos = 10) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5)
```

```{r v24n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v24.sim.fitted, pos = 20) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The true plot is identified.

```{r v24n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v24_simlcr, pos = 20) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- True plot may not be identified.

## Version 3

By sampling one value from 1 to 180 as the index of the data, I added 200 since the value is close to mean (`r summary(sleepstudy$Reaction)[4]`) to that specific reaction value as an obvious outlier.

```{r}
set.seed(20201010)
samp <- sample(1:180, 2)
repc3 <- sleepstudy
repc3[samp,]$Reaction <- repc3[samp,]$Reaction + 150 #summary(sleepstudy$Reaction)[4]/2
colnames(repc3)[1] <- c("y")
```

```{r}
slmod4 <- lmer(y ~ Days + (Days - 1|Subject) + (1|Subject), data = repc3)

v3.fitted <- extract.fitted.mod.v1(slmod4, repc3)
v3.lcr <- extract.lcr.mod.v1(slmod4, repc3)
v3.unit <- extract.unit.mod.v1(slmod4, repc3)
```


```{r}
ggplot(v3.fitted, aes(fitted, resm_std)) + geom_point() + geom_smooth(method = "loess")
ggplot(v3.fitted, aes(index, resm_std, color = (index %in% samp))) + geom_point() + theme(legend.position = "none")
ggplot(v3.fitted, aes(index, resc_std, color = (index %in% samp))) + geom_point() + theme(legend.position = "none") + geom_text(data = v3.fitted %>% filter(abs(resc_std)>4), aes(label = index), nudge_x = 0.35, nudge_y = 0.35, size = 2)
ggplot(v3.fitted,aes(fitted, resc_std)) + geom_point() 
ggplot(v3.unit, aes(index, Vi)) + geom_point()
ggplot(v3.fitted, aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red")
ggplot(v3.lcr, aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red")
```

```{r}
a <- cbind(v3.fitted[1:178,], v3.lcr)
b <- sort(a$resc_std)
c <- sort(a$resmcp)

plot(b,c)
abline(0,1)
```


### 1st replication

#### Simulation
```{r}
v31.sim <- sim(slmod4, repc3, seed = 2342)
```

```{r nullfitted-v31}
v31.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v31.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v31}
v31_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v31.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v31}
v31.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v31.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

#### Lineup plots

```{r v31n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v31.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_smooth(method = 'loess') +
  facet_wrap(~.sample, nrow = 5)
```

```{r v31n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v31.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v31n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v31.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

True plot might be seen (panel 9)

```{r v31n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v31.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The true plot should be identified.

```{r v31n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v31.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5)
```

```{r v31n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v31.sim.fitted, pos = 11) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v31n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v31_simlcr, pos = 11) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The conditional residual is easier to detect that if it follows a normal distribution. While the least confounded residual may be hard to identify.

### 2nd replication

#### Simulation

```{r}
v32.sim <- sim(slmod4, repc3, seed = 2353)
```

```{r nullfitted-v32}
v32.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v32.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v32}
v32_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v32.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v32}
v32.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v32.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

##### Lineup plots

```{r v32n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v32.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_smooth(method = 'loess') +
  facet_wrap(~.sample, nrow = 5)
```

```{r v32n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v32.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v32n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v32.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v32n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v32.sim.fitted, pos = 15) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```


```{r v32n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v32.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5)
```

```{r v32n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v32.sim.fitted, pos = 11) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- True plot is identified, then the conditonal residuals does not follow a normal distribution!

```{r v32n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v32_simlcr, pos = 11) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

### 3rd replication

#### Simulation

```{r}
v33.sim <- sim(slmod4, repc3, seed = 4352)
```

```{r nullfitted-v33}
v33.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v33.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v33}
v33_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v33.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v33}
v33.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v33.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

##### Lineup plots

```{r v33n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v33.sim.fitted, pos = 10) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_smooth(method = "loess") +
  facet_wrap(~.sample, nrow = 5)
```

```{r v33n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v33.sim.fitted, pos = 2) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v33n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v33.sim.unit, pos = 11) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v33n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v33.sim.fitted, pos = 2) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

True plot is identified.

```{r v33n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v33.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5)
```


```{r v33n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v33.sim.fitted, pos = 2) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

true plot is identified, the conditional residual does not follow a normal distribution.

```{r v33n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v33_simlcr, pos = 2) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

- The least conditional residual maybe not easy to be identified.

### 4th replication

#### Simulation

```{r}
v34.sim <- sim(slmod4, repc3, seed = 1234)
```

```{r nullfitted-v34}
v34.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v34.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull-v34}
v34_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v34.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit-v34}
v34.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v34.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

#### Lineup plots

```{r v34n-plo1, fig.height=6}
lineup(true = v1.fitted, samples = v34.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_smooth(method = "loess") +
  facet_wrap(~.sample, nrow = 5)
```

```{r v34n-plo2, fig.height=6}
lineup(true = v1.fitted, samples = v34.sim.fitted, pos = 2) %>% 
  ggplot(aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v34n-plo3, fig.height=6}
lineup(true = v1.unit, samples = v34.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v34n-plo4, fig.height=6}
lineup(true = v1.fitted, samples = v34.sim.fitted, pos = 2) %>% 
  ggplot(aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```

```{r v34n-plo5, fig.height=6}
lineup(true = v1.fitted, samples = v34.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + 
  facet_wrap(~.sample, nrow = 5)
```

```{r v34n-plo6, fig.height=6}
lineup(true = v1.fitted, samples = v34.sim.fitted, pos = 6) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) +
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```


```{r v34n-plo6-lcr, fig.height=6}
lineup(true = v1.lcr, samples = v34_simlcr, pos = 6) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5) + 
  xlab(NULL) + ylab(NULL) +
  theme(axis.text.y = element_blank(), axis.text.x = element_blank(),
        axis.ticks.x = element_blank(), axis.ticks.y = element_blank(), 
        legend.position="none")
```









