---
title: "case5"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lme4)
library(ggplot2)
library(mvtnorm)
library(dplyr)
library(tidyverse)
```

```{r}
data("sleepstudy")
head(sleepstudy)
skimr::skim(sleepstudy)
summary(sleepstudy)
```

```{r}
ggplot(sleepstudy, aes(Days, Reaction)) + geom_point() + facet_wrap(~Subject) + geom_smooth(method = "lm", se = FALSE)

ggplot(sleepstudy, aes(Subject, Reaction)) + geom_boxplot()
```

```{r}
testrandom <- plyr::ddply(sleepstudy, .(Subject), function(x) {
  m <- lm(Reaction ~ Days, data = x)
  data.frame(x, fitted = fitted(m))	
})

ggplot(testrandom, aes(Days, fitted, group = Subject)) + geom_line()
```

Therefore, from the plots, the model needs the random intercept and random slope.

```{r}
# random intercept and random slope
slmod1 <- lmer(Reaction ~ Days + (Days|Subject), data = sleepstudy)
# independent random effects
slmod2 <- lmer(Reaction ~ Days + (Days -1 |Subject) + (1|Subject), data = sleepstudy)
#summary(slmod1)
#summary(slmod2)

set.seed(987654321)
sl.mod2.sims  <- simulate(slmod2, nsim = 19)
sl.mod2.refit <- lapply(sl.mod2.sims, refit, object = slmod2)
sl.mod2.sim.ranef <- lapply(sl.mod2.refit, function(x) ranef(x)[[1]])
sl.mod2.sim.ranef <- do.call("rbind", sl.mod2.sim.ranef)
sl.mod2.sim.ranef$.n <- rownames(sl.mod2.sim.ranef)
sl.mod2.sim.ranef$.n <- as.numeric(str_extract(sl.mod2.sim.ranef$.n, "\\d+"))
true.sl.mod1.ranef <- ranef(slmod1)$Subject
sl_df <- nullabor:::add_true(sl.mod2.sim.ranef, true.sl.mod1.ranef, pos = 9)
ggplot(data = sl_df, aes(x = `(Intercept)`, y = Days)) + 
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, alpha = 0.4) +
  facet_wrap( ~ .sample, ncol=5) + 
  xlab(NULL) + 
  ylab(NULL)
```

Since the true plot is indistinguishable from the null plots, there is no need for the correlation between the random effects.

Hence the model is shown in `slmod2`.

From the true model, replicating the data for 4 times by $y \sim (X\beta, \Omega)$, where $\Omega = Z\Gamma Z^\top + R$ and refitting the model with $y = X\beta + Zb + e$ and get the plots & null plots.

- Version 1: 'best' model
- Version 2: slight noise (error is correlated such as `kronecker(diag(3), matrix(1, nrow = 2, ncol = 2))`, sample from the data by adding small values to the sample data)
- Version 3: Extreme value (with obvious outlier but not that obvious)

$$\boldsymbol y \sim N(X\beta, Z \Gamma Z^\top + R)$$

```{r fitfn}
extract.fitted.mod.v1 <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X")
  beta <- fixef(mod)
  Z <- getME(mod, "Z")
  u <- c(ranef(mod)$Subject[,1], ranef(mod)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted <-  as.vector(X %*% beta)
  resm <-  y - fitted
  resc <-  as.vector(y - fitted - Z %*% u)

  fitted_df <- v1_df %>% 
    mutate(fitted = as.vector(X %*% beta),
           resm = y - fitted,
           resc = as.vector(y - fitted - Z %*% u),
           index = 1:nrow(v1_df)) %>% 
    rowwise() %>% 
    mutate(resm_std = resm/sqrt(diag(varMargRes)[index]),
           resc_std = resc/sqrt(diag(varCondRes)[index])) %>% 
    ungroup()
  
  return(fitted_df)
}
```

```{r unitfn}
extract.unit.mod.v1 <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X")
  beta <- fixef(mod)
  Z <- getME(mod, "Z")
  u <- c(ranef(mod)$Subject[,1], ranef(mod)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted <-  as.vector(X %*% beta)
  resm <-  y - fitted
  resc <-  as.vector(y - fitted - Z %*% u)

  unit_df <- expand_grid(subjects) %>% 
  dplyr::mutate(Vi = map_dbl(subjects, ~{
    ind <- data %>% 
      dplyr::mutate(index = 1:n()) %>% 
      filter(Subject == .x) %>% 
      pull(index)
    mi <- length(ind)
    Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
    #norm((diag(mi)- Ei %*% t(Ei)))
    v1 <- (diag(mi)- Ei %*% t(Ei))
    sqrt(sum(diag(v1 %*% t(v1)))) / mi
    #sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
  }),
  Mi = as.vector(t(u) %*% solve(varU) %*% u),
  index = 1:n())
  
  return(unit_df)
}
```

```{r lcrfn}
extract.lcr.mod.v1 <- function(mod, data){
  N <- nrow(data)
  subjects <- unique(data$Subject)
  nsubjects <- length(subjects)

  y <- data$y
  X <- getME(mod, "X")
  beta <- fixef(mod)
  Z <- getME(mod, "Z")
  u <- c(ranef(mod)$Subject[,1], ranef(mod)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(mod))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 

  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(mod) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(mod) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted <-  as.vector(X %*% beta)
  resm <-  y - fitted
  resc <-  as.vector(y - fitted - Z %*% u)

  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% v11_fitted$resc[1:N] )/sqrt(diag(var.resmcp))

  resmcp_sl <- tibble::tibble(resmcp)
  
  return(resmcp_sl)
}
```

```{r simulate}
sim <- function(mod, data, nsim = 19, std = FALSE){
  fit.sim <- simulate(mod, nsim = nsim, seed = 1234)
  fit.refit <- lapply(fit.sim, refit, object = mod)
  fit.simy <- lapply(fit.refit, function(x) getME(x, 'y'))
  fit.simy.y <- do.call("cbind", fit.simy)
  fit.simy.y <- reshape2::melt(fit.simy.y)[-1]
  names(fit.simy.y) <- c(".n", "y")
  fit.simy.y$.n <- as.numeric(str_extract(fit.simy.y$.n, "\\d+"))
  fit.simy.y$Subject <- rep(data$Subject, 19)
  fit.simy.y$Days <- rep(data$Days, 19)
  return(fit.simy.y)
}
```

## Version 1

```{r}
N <- nrow(sleepstudy)
subjects <- unique(sleepstudy$Subject)
nsubjects <- length(subjects)

y <- sleepstudy$Reaction
X <- model.matrix(~ Days, data = sleepstudy)
beta <- fixef(slmod2)
Z <- getME(slmod2, "Z")
u <- c(ranef(slmod2)$Subject[,1], ranef(slmod2)$Subject[,2])
q <- length(u)

vc <- as.data.frame(VarCorr(slmod2))
R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
G <- Matrix::bdiag(G1, G2)

Sigma <- Z %*% G %*% t(Z) + R 

# first replication
y1 <- as.vector(rmvnorm(1, mean = X %*% beta, sigma = Sigma, checkSymmetry = FALSE))

v1_df <- tibble(y1, sleepstudy$Days, sleepstudy$Subject)
colnames(v1_df) <- c('y', 'Days', 'Subject')

# second replication
y2 <- as.vector(rmvnorm(1, mean = X %*% beta, sigma = Sigma, checkSymmetry = FALSE))
v1_df2 <- tibble(y2, sleepstudy$Days, sleepstudy$Subject)
colnames(v1_df2) <- c('y', 'Days', 'Subject')

# third replication
y3 <- as.vector(rmvnorm(1, mean = X %*% beta, sigma = Sigma, checkSymmetry = FALSE))
v1_df3 <- tibble(y3, sleepstudy$Days, sleepstudy$Subject)
colnames(v1_df3) <- c('y', 'Days', 'Subject')

# fourth replication
y4 <- as.vector(rmvnorm(1, mean = X %*% beta, sigma = Sigma, checkSymmetry = FALSE))
v1_df4 <- tibble(y4, sleepstudy$Days, sleepstudy$Subject)
colnames(v1_df4) <- c('y', 'Days', 'Subject')
```

### 1st replication
```{r}
v11.mod <- lmer(y ~ Days + (Days-1|Subject) + (1|Subject), data = v1_df)

v11_fitted <- extract.fitted.mod.v1(v11.mod, v1_df)

v11_unit <- extract.unit.mod.v1(v11.mod, v1_df)
```

#### Plots

```{r v11-plot1}
ggplot(v11_fitted, aes(fitted, resm_std)) + geom_point() + geom_hline(yintercept = 0)
```


```{r v11-plot2}
ggplot(v11_fitted, aes(index, resm_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0) 
```


```{r v11-plot3}
ggplot(v11_unit, aes(1:nrow(v11_unit), Vi)) + geom_point()
```


```{r v11-plot4}
ggplot(v11_fitted, aes(index, resc_std, color = Subject)) + geom_point() + geom_hline(yintercept = 0)
```


```{r v11-plot5}
ggplot(v11_fitted, aes(fitted, resc_std)) + geom_point() + geom_hline(yintercept = 0)
```


```{r v11-plot6}
ggplot(v11_fitted, aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red")
```

##### Least confounded conditional residual
```{r}
v11_lcr <- extract.lcr.mod.v1(v11.mod, v1_df)
```

```{r v11-plot6-lcr}
ggplot(v11_lcr, aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red")
```

```{r v11-plot7}
ggplot(v11_unit, aes(index, Mi)) + geom_point()
```

```{r v11-plot8}
ggplot(v11_unit, aes(sample = Mi)) +
  geom_qq(distribution = stats::qchisq,
          dparams = list(df = q)) + 
  geom_qq_line(color = "red",
               distribution = stats::qchisq,
               dparams = list(df = q))
```



#### Simulation

```{r}
v11.sim <- sim(v11.mod, v1_df)
```


```{r nullfitted}
v11.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v11.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

##### Lineup plots

```{r v11n-plot1, fig.height=6}
lineup(true = v11_fitted, samples = v11.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5)
```


```{r v11n-plot2, fig.height=6}
lineup(true = v11_fitted, samples = v11.sim.fitted, pos = 9) %>% 
  ggplot(aes(index, resm_std)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5)
```

```{r v11n-plot4, fig.height=6}
lineup(true = v11_fitted, samples = v11.sim.fitted, pos = 9) %>% 
  ggplot(aes(index, resc_std)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5)
```

```{r v11n-plot5, fig.height=6}
lineup(true = v11_fitted, samples = v11.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + 
  geom_point() + 
  geom_hline(yintercept = 0) +
  facet_wrap( ~ .sample, ncol=5)
```

```{r v11n-plot6, fig.height=6}
lineup(true = v11_fitted, samples = v11.sim.fitted, pos = 9) %>% 
  ggplot(aes(sample = resc_std)) + 
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol=5)
```

```{r lcrsimnull}
v11_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v11.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))

  tibble::tibble(df[1:178,], resmcp)
})
```

```{r v11n-plot6-lcr, fig.height=6}
lineup(true = v11_lcr, samples = v11_simlcr, pos = 9) %>% 
  ggplot(aes(sample = resmcp)) + 
  geom_qq() + geom_qq_line(color = "red") +
  facet_wrap( ~ .sample, ncol=5)
```

```{r nullunit}
v11.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v11.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

```{r v11n-plot3, fig.height=6}
lineup(true = v11_unit, samples = v11.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```


```{r v11n-plot7, fig.height=6}
lineup(true = v11_unit, samples = v11.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Mi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v11n-plot8, fig.height=6}
lineup(true = v11_unit, samples = v11.sim.unit, pos = 9) %>% 
  ggplot(aes(sample = Mi)) +
  geom_qq(distribution = stats::qchisq,
          dparams = list(df = q)) + 
  geom_qq_line(color = "Red",
               distribution = stats::qchisq,
               dparams = list(df = q)) +
  facet_wrap(~.sample, nrow = 5)
```


## Version 2

Setting the error term with the correlation, such as the first five elements are correlated (covariance is 5), and the next five elements are correlated and keep going

```{r}
repc <- sleepstudy

samp <- sample(1:180, 36)

repc[samp,]$Reaction <-  repc[samp,]$Reaction+ 1

```


```{r}
N <- nrow(repc)
subjects <- unique(repc$Subject)
nsubjects <- length(subjects)

y <- repc$Reaction
X <- model.matrix(~ Days, data = repc)
beta <- fixef(slmod2)
Z <- getME(slmod2, "Z")
u <- c(ranef(slmod2)$Subject[,1], ranef(slmod2)$Subject[,2])
q <- length(u)

vc <- as.data.frame(VarCorr(slmod2))
R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
G <- Matrix::bdiag(G1, G2)

Sigma <- Z %*% G %*% t(Z) + R 

y1 <- as.vector(rmvnorm(1, mean = X %*% beta, sigma = Sigma, checkSymmetry = FALSE))
v2_df <- tibble(y1, repc$Days, repc$Subject)
colnames(v2_df) <- c('y', 'Days', 'Subject')
```

### 1st replication

```{r}
v21.mod <- lmer(y ~ Days + (Days-1|Subject) + (1|Subject), data = v2_df)

v21_fitted <- extract.fitted.mod.v1(v21.mod, v2_df)

v21_unit <- extract.unit.mod.v1(v21.mod, v2_df)
```

#### Plots

```{r v21-plot1}
ggplot(v21_fitted, aes(fitted, resm_std)) + geom_point()
```

```{r v21-plot2}
ggplot(v21_fitted, aes(index, resm_std)) + geom_point()
```

```{r v21-plot3}
ggplot(v21_unit, aes(1:nrow(v21_unit), Vi)) + geom_point()
```

```{r v21-plot4}
ggplot(v21_fitted, aes(index, resc_std)) + geom_point()
```

```{r v21-plot5}
ggplot(v21_fitted, aes(fitted, resc_std)) + geom_point()
```

```{r v21-plot6}
ggplot(v21_fitted, aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red")
```

```{r v21-plot6-lcr}
v21_lcr <- extract.lcr.mod.v1(v21.mod, v2_df)

ggplot(v21_lcr, aes(sample = resmcp)) + geom_qq() + geom_qq_line(color= "red")
```


```{r v21-plot7}
ggplot(v21_unit, aes(index, Mi)) + geom_point()
```

```{r v21-plot8}
ggplot(v21_unit, aes(sample = Mi)) + 
  geom_qq(distribution = stats::qchisq,
          dparams = list(df = q)) +
  geom_qq_line(color = "Red",
               distribution = stats::qchisq,
               dparams = list(df = q))
```

### Simulation

```{r}
v21.sim <- sim(v21.mod, v2_df)
```

```{r nullfitted}
v21.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v21.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull}
v21_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v21.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit}
v21.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v21.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

#### Lineup plots

```{r v21n-plo1, fig.height=6}
lineup(true = v21_fitted, samples = v21.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

```{r v21n-plo2, fig.height=6}
lineup(true = v21_fitted, samples = v21.sim.fitted, pos = 9) %>% 
  ggplot(aes(index, resm_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

```{r v21n-plo3, fig.height=6}
lineup(true = v21_unit, samples = v21.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v21n-plo4, fig.height=6}
lineup(true = v21_fitted, samples = v21.sim.fitted, pos = 9) %>% 
  ggplot(aes(index, resc_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

From this plot, we can see that the panel 9 is the most different one which is the true plot.

```{r v21n-plo5, fig.height=6}
lineup(true = v21_fitted, samples = v21.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

True plot should be identified (panel 9)

```{r v21n-plo6, fig.height=6}
lineup(true = v21_fitted, samples = v21.sim.fitted, pos = 10) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5)
```

True plot should be identified (panel 10).

```{r v21n-plo6-lcr, fig.height=6}
lineup(true = v21_lcr, samples = v21_simlcr, pos = 13) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5)
```

```{r v21n-plo7, fig.height=6}
lineup(true = v21_unit, samples = v21.sim.unit, pos = 6) %>% 
  ggplot(aes(index, Mi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v21n-plo8, fig.height=6}
lineup(true = v21_unit, samples = v21.sim.unit, pos = 6) %>% 
  ggplot(aes(sample = Mi)) + 
  geom_qq(distribution = stats::qchisq,
          dparams = list(df = q)) +
  geom_qq_line(color = "red",
               distribution = stats::qchisq,
               dparams = list(df = q)) +
  facet_wrap(~.sample, nrow = 5)
```

## Version 3

By sampling one value from 1 to 180 as the index of the data, I added 200 to that specific reaction value as an obvious outlier.

```{r}
samp <- sample(1:180, 1)
repc3 <- sleepstudy
repc3[samp,]$Reaction <- repc3[samp,]$Reaction + 200
```

```{r}
slmod4 <- lmer(Reaction ~ Days + (Days - 1|Subject) + (1|Subject), data = repc3)

N <- nrow(repc3)
subjects <- unique(repc3$Subject)
nsubjects <- length(subjects)

y <- repc3$Reaction
X <- model.matrix(~ Days, data = repc)
beta <- fixef(slmod4)
Z <- getME(slmod4, "Z")
u <- c(ranef(slmod4)$Subject[,1], ranef(slmod4)$Subject[,2])
q <- length(u)

vc <- as.data.frame(VarCorr(slmod4))
R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
G <- Matrix::bdiag(G1, G2)

Sigma <- Z %*% G %*% t(Z) + R 

y1 <- as.vector(rmvnorm(1, mean = X %*% beta, sigma = Sigma, checkSymmetry = FALSE))
v3_df <- tibble(y1, repc$Days, repc$Subject)
colnames(v3_df) <- c('y', 'Days', 'Subject')
```

### 1st replication
```{r}
v31.mod <- lmer(y ~ Days + (Days - 1|Subject) + (1|Subject), data = v3_df)
v31_fitted <- extract.fitted.mod.v1(v31.mod, v3_df)
v31_lcr <- extract.lcr.mod.v1(v31.mod, v3_df)
v31_unit <- extract.unit.mod.v1(v31.mod, v3_df)
```

#### Plots
```{r plot1}
ggplot(v31_fitted, aes(fitted, resm_std)) + geom_point() + geom_hline(yintercept = 0)
```

```{r plot2}
ggplot(v31_fitted, aes(index, resm_std)) + geom_point() + geom_hline(yintercept = 0)
```

```{r plot3}
ggplot(v31_unit, aes(index, Vi)) + geom_point()
```

```{r plot4}
ggplot(v31_fitted, aes(index, resc_std)) + geom_point() + geom_hline(yintercept = 0)
```

```{r plot5}
ggplot(v31_fitted, aes(fitted, resc_std)) + geom_point() + geom_hline(yintercept = 0)
```

```{r plot6}
ggplot(v31_fitted, aes(sample = resm_std)) + geom_qq() + geom_qq_line(color = "red")
```

```{r plot6-lcr}
ggplot(v31_lcr, aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red")
```

```{r plot7}
ggplot(v31_unit, aes(index, Mi)) + geom_point()
```

```{r plot8}
ggplot(v31_unit, aes(sample = Mi)) + 
  geom_qq(distribution = stats::qchisq,
          dparams = list(df = q)) +
  geom_qq_line(color = "red",
               distribution = stats::qchisq,
               dparams = list(df = q))
```

### Simulation
```{r}
v31.sim <- sim(v31.mod, v3_df)
```

```{r nullfitted}
v31.sim.fitted <- purrr::map_dfr(1:19, function(i){
  df <- v31.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  tibble::tibble(df, fitted, resm_std, resc_std, index)
})
```

```{r lcrsimnull}
v31_simlcr <- purrr::map_dfr(1:19, function(i){
  df <- v31.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  R_half <- expm::sqrtm(R)

  auxqn <- eigen((R_half %*% P %*% R_half), symmetric = T, only.values = FALSE)

  p <- length(beta)

  lt <- sqrt(solve(diag((auxqn$values[1:(N-p)])))) %*% t(auxqn$vectors[1:N,1:(N-p)]) %*% solve(expm::sqrtm(R[1:N,1:N]))

  var.resmcp <- lt %*% varCondRes[1:N,1:N] %*% t(lt)

  resmcp <- (lt %*% resc[1:N] )/sqrt(diag(var.resmcp))
  .n = i

  tibble::tibble(.n, resmcp)
})
```

```{r nullunit}
v31.sim.unit <- purrr::map_dfr(1:19, function(i){
  df <- v31.sim %>% filter(.n == i)
  m <- lmer(y ~ Days + (Days -1 |Subject) + (1|Subject), data = df)
  
  N <- nrow(df)
  subjects <- unique(df$Subject)
  nsubjects <- length(subjects)

  y <- df$y
  X <- model.matrix(~ Days, data = df)
  beta <- fixef(m)
  Z <- getME(m, "Z")
  u <- c(ranef(m)$Subject[,1], ranef(m)$Subject[,2])
  q <- length(u)

  vc <- as.data.frame(VarCorr(m))
  R <- vc$vcov[vc$grp == 'Residual'] * diag(N)
  G1 <- vc$vcov[vc$grp == 'Subject'] * diag(nsubjects)
  G2 <- vc$vcov[vc$grp == 'Subject.1'] * diag(nsubjects)
  G <- Matrix::bdiag(G1, G2)

  Sigma <- Z %*% G %*% t(Z) + R 
  Sigma_inv <- solve(Sigma)

  P <- Sigma_inv - Sigma_inv %*% X %*% vcov(m) %*% t(X) %*% Sigma_inv

  varMargRes <- Sigma - X %*% vcov(m) %*% t(X) 
  varCondRes <- R %*% P %*% R  
  varU <- G - G %*% t(Z) %*% P %*% Z %*% G
  
  fitted = as.vector(X %*% beta)
  resm = y - fitted
  resc = y - fitted - as.vector(Z %*% u)
  index = 1:nrow(df)
  resm_std = resm / sqrt(diag(varMargRes)[index])
  resc_std = resc / sqrt(diag(varCondRes)[index])
  
  expand_grid(subjects) %>% 
    dplyr::mutate(Vi = map_dbl(subjects, ~{
      ind <- df %>% 
        mutate(index = 1:n()) %>% 
        filter(Subject == .x) %>% 
        pull(index)
      mi <- length(ind)
      Ei <- solve(expm::sqrtm(varMargRes[ind, ind])) %*% resm[ind]
      sqrt(sum((diag(mi) - Ei %*% t(Ei))^2)) / mi
      }),
      Mi = as.vector(t(u) %*% solve(varU) %*% u),
      index = 1:n(),
      .n = i)
})
```

#### Lineup plots

```{r v31n-plo1, fig.height=6}
lineup(true = v31_fitted, samples = v31.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resm_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

```{r v31n-plo2, fig.height=6}
lineup(true = v31_fitted, samples = v31.sim.fitted, pos = 9) %>% 
  ggplot(aes(index, resm_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

```{r v31n-plo3, fig.height=6}
lineup(true = v31_unit, samples = v31.sim.unit, pos = 9) %>% 
  ggplot(aes(index, Vi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

True plot might be seen (panel 9)

```{r v31n-plo4, fig.height=6}
lineup(true = v31_fitted, samples = v31.sim.fitted, pos = 9) %>% 
  ggplot(aes(index, resc_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

True plot is identified.

```{r v31n-plo5, fig.height=6}
lineup(true = v31_fitted, samples = v31.sim.fitted, pos = 9) %>% 
  ggplot(aes(fitted, resc_std)) + geom_point() + geom_hline(yintercept = 0) +
  facet_wrap(~.sample, nrow = 5)
```

```{r v31n-plo6, fig.height=6}
lineup(true = v31_fitted, samples = v31.sim.fitted, pos = 10) %>% 
  ggplot(aes(sample = resc_std)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5)
```

True plot can be identified (panel 10)

```{r v31n-plo6-lcr, fig.height=6}
lineup(true = v31_lcr, samples = v31_simlcr, pos = 13) %>% 
  ggplot(aes(sample = resmcp)) + geom_qq() + geom_qq_line(color = "red") +
  facet_wrap(~.sample, nrow = 5)
```

```{r v31n-plo7, fig.height=6}
lineup(true = v31_unit, samples = v31.sim.unit, pos = 6) %>% 
  ggplot(aes(index, Mi)) + geom_point() +
  facet_wrap(~.sample, nrow = 5)
```

```{r v31n-plo8, fig.height=6}
lineup(true = v31_unit, samples = v31.sim.unit, pos = 6) %>% 
  ggplot(aes(sample = Mi)) + 
  geom_qq(distribution = stats::qchisq,
          dparams = list(df = q)) +
  geom_qq_line(color = "red",
               distribution = stats::qchisq,
               dparams = list(df = q)) +
  facet_wrap(~.sample, nrow = 5)
```












